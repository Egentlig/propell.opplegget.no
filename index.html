<!DOCTYPE html>
<html lang="nb">
<head>
    <title>Propellopplegget</title>

    <link href="style/style.css" rel="stylesheet">
</head>
<body>

<div class="content-center">
    <h1>Propellopplegget</h1>
</div>

<div class="content-center">
    <img src="media/propell.webp" alt="Propelleringsmessig emblem">
</div>

<div class="content-center">
    <h2 id="dagensPropellering" class="hide">Laster dagens propellering...</h2>
    <h4 id="dagensMinstePropellering" class="hide">Laster dagens minste propellering...</h4>
    <h5 id="gjennomsnittligPropellering" class="hide">Laster gjennomsnittlig propellering...</h5>
</div>

<div class="content-center">
    <h3 id="historiskPropellering" class="hide">Historisk propellering</h3>
</div>

<table id="historiskPropelleringTable" class="content-center hide">
    <thead>
    <tr>
        <th>Dag</th>
        <th>Topp propell</th>
        <th>Propellering</th>
        <th>Minste propell</th>
        <th>Propellering</th>
        <th>Gjennomsnitt</th>
    </tr>
    </thead>
    <tbody id="historiskPropelleringBody">

    </tbody>
</table>

<div id="forstegir" class="content-center hide">
    <p>
        Propelleringen påvirkes av <a href="https://twitch.tv/forstegir">Førstegir</a> i større eller mindre grad
    </p>
</div>

<div id="resorted" class="content-center hide">
    <p class="x-small">
        Takk til Resorted som sørger for at formatet på propell-meldingen til StreamElements ikke endres på *
    </p>
    <p class="xx-small">
        * Overhengende fare for pungsmekk hvis den endres :)
    </p>
</div>

<script type="application/javascript">
    const hentDagensPropellering = async () => {
        const dagensPropellering = document.querySelector("#dagensPropellering");
        const dagensMinstePropellering = document.querySelector("#dagensMinstePropellering");
        const gjennomsnittligPropellering = document.querySelector("#gjennomsnittligPropellering");

        try {
            const response = await fetch("https://api.opplegget.no/twitch/user/propellering/v1/dagens-propellering");

            const dagensPropelleringJson = await response.json()
            const toppPropell = dagensPropelleringJson.toppPropell;
            const bunnPropell = dagensPropelleringJson.bunnPropell;

            dagensPropellering.innerText = `Topp propell i dag er ${toppPropell.visningsnavn} med hele ${toppPropell.propellering}% propellering`;
            dagensMinstePropellering.innerText = `Minste propell i dag er ${bunnPropell.visningsnavn} med kun ${bunnPropell.propellering}% propellering`;
            gjennomsnittligPropellering.innerText = `Gjennomsnittlig propellering i dag er ${dagensPropelleringJson.statistikk.gjennomsnitt}%`
        } catch (error) {
            dagensPropellering.innerText = `Ingen propell i dag :(`;
            dagensMinstePropellering.innerText = ``;
            console.error(error);
        }

        dagensPropellering.classList.remove("hide");
        dagensMinstePropellering.classList.remove("hide");
        gjennomsnittligPropellering.classList.remove("hide");
    }

    const hentHistoriskPropellering = async () => {
        const response = await fetch("https://api.opplegget.no/twitch/user/propellering/v1/historisk-propellering");

        const historiskPropellering = document.querySelector("#historiskPropellering");
        const historiskPropelleringTable = document.querySelector("#historiskPropelleringTable");
        const historiskPropelleringBody = document.querySelector("#historiskPropelleringBody");

        const propelleringshistorikk = await response.json();
        propelleringshistorikk.forEach(propellering => {
            const toppPropell = propellering.toppPropell;
            const bunnPropell = propellering.bunnPropell;

            const row = document.createElement("tr");

            const dagData = document.createElement("td");
            dagData.innerText = toppPropell.dag;
            row.appendChild(dagData);

            const propellData = document.createElement("td");
            propellData.innerText = toppPropell.visningsnavn != null ? toppPropell.visningsnavn : "Ingen propell!";
            row.appendChild(propellData);

            const propelleringData = document.createElement("td");
            propelleringData.innerText = toppPropell.propellering != null ? `${toppPropell.propellering}%` : "-";
            row.appendChild(propelleringData);

            const minstePropellData = document.createElement("td");
            minstePropellData.innerText = bunnPropell.visningsnavn != null ? bunnPropell.visningsnavn : "Ingen propell!";
            row.appendChild(minstePropellData);

            const minstePropelleringData = document.createElement("td");
            minstePropelleringData.innerText = bunnPropell.propellering != null ? `${bunnPropell.propellering}%` : "-";
            row.appendChild(minstePropelleringData);

            const gjennomsnittligPropelleringData = document.createElement("td");
            gjennomsnittligPropelleringData.innerText = propellering.statistikk.gjennomsnitt != null ? `${propellering.statistikk.gjennomsnitt}%` : "-";
            row.appendChild(gjennomsnittligPropelleringData);

            historiskPropelleringBody.appendChild(row);
        });

        historiskPropellering.classList.remove("hide");
        historiskPropelleringTable.classList.remove("hide");
    }

    document.addEventListener("DOMContentLoaded", () => {
        Promise.all([
            hentDagensPropellering(),
            hentHistoriskPropellering()
        ]).then(() => {
            document.querySelector("#forstegir").classList.remove("hide");
            document.querySelector("#resorted").classList.remove("hide");
        }).catch(reason => console.error(`Initial load failed. Reason: ${reason}`));
    });
</script>
</body>
</html>
